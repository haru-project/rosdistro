name: Auto-Update rosdep.yaml

on:
    repository_dispatch:
        types: [repository_created]

    schedule:
        # Run every 30 minutes as fallback
        - cron: "*/30 * * * *"

    workflow_dispatch:
        inputs:
            repository_name:
                description: "Repository name to process (optional)"
                required: false
                type: string
            force_update:
                description: "Force update existing entries"
                required: false
                type: boolean
                default: false

jobs:
    update-rosdep:
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.ROSDEP_UPDATE_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  pip install PyYAML xmltodict

            - name: Configure Git
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

            - name: Process repositories
              run: python scripts/main.py
              env:
                  GITHUB_TOKEN: ${{ secrets.ROSDEP_UPDATE_TOKEN }}
                  REPOSITORY_NAME: ${{ github.event.client_payload.repository.name || github.event.inputs.repository_name }}
                  FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
                  GITHUB_ACTOR: ${{ github.actor }}

            - name: Commit and push changes
              run: |
                  if git diff --quiet; then
                      echo "No changes to commit"
                  else
                      git add rosdep.yaml
                      git commit -m "Auto-update rosdep.yaml with new ROS packages

                      - Scanned haru-project organization for new repositories
                      - Added rosdep entries for ROS2 distributions: Humble (jammy), Jazzy & Kilted (noble)
                      - Package name conversion (underscore â†’ hyphen)
                      - YAML syntax validated

                      Triggered by: ${{ github.event_name }}
                      Actor: ${{ github.actor }}"
                      git push
                  fi
